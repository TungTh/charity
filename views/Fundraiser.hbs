<nav class="navbar navbar-expand-sm bg-danger navbar-dark">
  <ul class="navbar-nav">
    <li class="nav-item"><a class="nav-link" href="/">About Us</a></li>
    <li class="nav-item "><a class="nav-link" href="/deploy">Start Your Own</a></li>
    <li class="nav-item  active"><a class="nav-link" href="/List_fundraiser">Fundraisers</a></li>
        <li class="nav-item "><a class="nav-link" href="/audit">Coin Sharing and Fundraiser Audit</a></li>

  </ul>
</nav>
<link href="https://fonts.googleapis.com/css?family=Handlee|Pacifico" rel="stylesheet">
<style>
.w3-Handlee{
font-family: 'Handlee', cursive;
}

</style>
<div class="container" style="margin-top:30px">
  <div class="row">
  <div class="col-sm-8">
      <img class="img-fluid" src="{{item.poster}}">
      <h2>The Story</h2>
      <h4><i><b>{{item.title}}</b></i></h4>
        <i class="w3-opacity w3-left w3-small w3-wide" id="date"></i><br><br>
      {{{item.content}}}
      <br>
      <h2 id="donators">Thank You<button type="button" class="btn btn-default btn-sm w3-right" onclick="refresh()"><span class="glyphicon glyphicon-refresh"></span> Refresh</button></h2>
      <table class="table">
        <thead>
            <tr>
                <th>Address</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody id="list">
        </tbody>
    </table>
    </div>

    <div class="col-sm-4 w3-center">
      <h1 id ="total"></h1><div id="goal"class="w3-small"></div>
      <h5></h5>
      <p></p><div class="progress">
        <div id="prgress-bar"class="progress-bar w3-pink" role="progressbar"aria-valuemin="0" aria-valuemax="100" style="width:0%">
                <span class="sr-only"></span>
        </div>
      </div></p>
      <p ><input id="amount" type="number"style="height:43px;width:50%"><img  style="height:43px;margin-left:20px" src="/images/iucoin.png"></img></p>
      {{!-- <button class="w3-button w3-pink w3-round-large" style="width:100%"id="donate" onclick="Donate()">DONATE NOW</button> --}}
      <p id="status"></p>
      <p class="w3-Handlee">Share your love and get 10 EXP coins as a gift ! (only one time)  </p>
      <p id="count"></p>
      <p id="owner"></p>
      <p id="noti"></p>
      <ul class="nav nav-pills flex-column">
      <hr class="d-sm-none">
    </div>
  </div>
</div>



{{!-- setTimeout(location.reload(), 10000); --}}

{{!-- <p id="total"></p> --}}

<script src="/javascripts/FundraiserABI.js"></script>
<script>
  

  var address ="{{item.address}}";
  var contract = fundraiserContract.at(address);
 //Onload functions...........................................................................................................................................................................................      

  contract.getInfo(function(error, result) {
    if (!error) {
        var owner = result[0];
        var total = result[1];
        var goal = result[2];
        var ratio = (total/goal)*100;
        var  months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        var start = new Date(result[3]*1000);
        var end = new Date(result[4]*1000);
        var isOpen=result[5];
        var isEarly = result[6];
        var isWithdraw = result[7];
        var isActive=result[8];
        var from=start.getDate()+" "+months[start.getMonth()]+", "+start.getFullYear();
        var to=end.getDate()+" "+months[end.getMonth()]+", "+end.getFullYear();
        document.getElementById("date").innerHTML=from+" ----- "+to;
        document.getElementById("total").innerHTML=total;
        document.getElementById("goal").innerHTML="of "+goal+" coins goal";
        document.getElementById("prgress-bar").style.width=ratio+"%";
        if(isOpen==false){
            if(!isWithdraw) $("#status").append("<div class=\"w3-button w3-wide w3-dark-grey w3-round-large\" style=\"width:100%\">WAIT FOR OPENNING</div>");
            else $("#status").append("<div class=\"w3-button w3-wide w3-dark-grey w3-round-large\" style=\"width:100%\">CLOSED</div>");
        } 
        else {
            if(isEarly==true) $("#status").append("<div class=\"w3-button w3-wide w3-dark-grey w3-round-large w3-center\" style=\"width:100%\">NOT AVAILABLE YET</div>");

            else{
                
              if(isActive==true){
                $("#status").append("<button class=\"w3-button w3-wide w3-pink w3-round-large w3-center\" style=\"width:100%\"id=\"donate\" onclick=\"Donate()\">DONATE NOW</button>");
                var x = setInterval(function() {

                    // Get todays date and time
                    var now = new Date().getTime();
                    
                    // Find the distance between now an the count down date
                    var distance = end - now;
                    
                    // Time calculations for days, hours, minutes and seconds
                    var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    // Output the result in an element with id="demo"
                    document.getElementById("count").innerHTML ="Only "+ days + "d " + hours + "h "
                    + minutes + "m " + seconds + "s left.";
                    
                    // If the count down is over, write some text 
                    if (distance < 0) {
                        clearInterval(x);
                    }
                }, 1000);

              } 

              else {
                $("#status").append("<div class=\"w3-button w3-wide w3-dark-grey w3-round-large w3-center\" style=\"width:100%\">EXPIRED</div>");
                    if(!isWithdraw) $("#owner").append("<button class=\"w3-button w3-wide w3-pink w3-round-large w3-center\" style=\"width:100%\"id=\"donate\" onclick=\"withdrawNow()\">WITHDRAW COIN</button>");
                    else $("#owner").append("<button class=\"w3-button w3-wide w3-pink w3-round-large w3-center\" style=\"width:100%\"id=\"donate\">DONE</button>");
              }
            }
        }

       
    } else
        console.log(error);
    });

 contract.getDonators(function(error, result) {
           if (!error) {
               var i;
               text="";
               for(i=0;i<result.length; i++){
                    contract.getDonationOf (result[i],function(error, res) {
                        if (!error) {
                            $("#list").append(" <tr><td>"+res[0]+"</td><td>"+res[1]+"</td></tr>");
                            console.log(res);
                        } else
                                console.log(error);
                    });
               }
           } else
                console.log(error);
       });

 //Button function...........................................................................................................................................................................................      
    function Donate(){
        contract.donate($("#amount").val(),
            function(error, result) {
                if (!error) {
                    var donate_success = contract.Notification();
                    donate_success.watch(function(error,res){
                        if(!error){
                            document.getElementById("total").innerHTML=res.args.total;
                            document.getElementById("noti").innerHTML="Thank <i>\""+res.args._address+"\"</i> for donating "+res.args.amount+" coin(s). You "+res.args.message;
                        }
                        else{
                        }
                    });
                        
                }
                else
                    document.getElementById("noti").innerHTML="Failed to make transaction. Please check again your gasLimit or donation amount must greater than 0 coin(s).";
            }
        );
    }


   

    function withdrawNow(){
        contract.ownerWidthdraw(function(error, result) {
           if (!error) {
               if(result) document.getElementById("noti").innerHTML="Fundraiser closed."
                else  document.getElementById("noti").innerHTML="You are not the owner of this Fundraiser."

           } else document.getElementById("noti").innerHTML="Failed to make transaction."

            
       });
    }

    

    function refresh(){
        location.reload();
    }


</script>
<P>{{{item.address}}}</P>


